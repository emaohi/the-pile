generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

model Item {
  id          String   @id @default(cuid())

  // Content - stored as JSON for flexibility
  sourceType  String   // 'link' | 'text' | 'document'
  sourceData  String   // JSON: { url, content } | { content, attribution } | { fileId, fileName, extractedText }

  title       String
  description String?
  estimatedMinutes Int?

  // Origin
  sourceId    String?
  source      Source?  @relation(fields: [sourceId], references: [id])
  savedAt     DateTime @default(now())
  userNote    String?

  // AI-generated
  aiSummary   String?

  // State
  status      String   @default("queued") // 'queued' | 'kept' | 'revisit' | 'discarded'
  priorityScore Float  @default(0)

  // Engagement
  readAt      DateTime?
  takeaway    String?
  takeawayAt  DateTime?
  verdict     String?  // 'keep' | 'revisit' | 'discard'
  verdictAt   DateTime?

  // Revisit tracking
  revisitCount Int     @default(0)
  revisitAfter DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tags        ItemTag[]
  followUps   AIFollowUp[]
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  items ItemTag[]
}

model ItemTag {
  itemId String
  tagId  String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([itemId, tagId])
}

model Source {
  id        String   @id @default(cuid())

  // Configuration
  type      String   // 'blog' | 'youtube'
  url       String   @unique
  name      String

  // Fetch settings
  interval  String   @default("daily") // 'hourly' | 'daily' | 'weekly'
  maxPerFetch Int    @default(3)
  coldStartWindow String @default("30d") // '7d' | '30d' | '90d' | 'all'

  // Topic filtering
  topicFilter String?
  topicFilterEnabled Boolean @default(false)

  // Auto-tagging (stored as JSON array)
  autoTags  String   @default("[]")

  // State
  fetchedItemIds String @default("[]") // JSON array of item IDs
  lastFetchedAt DateTime?
  lastFetchStatus String @default("pending") // 'success' | 'error' | 'pending'
  lastFetchError String?

  // Stats
  itemsFetchedTotal Int @default(0)
  itemsQueuedTotal Int @default(0)
  itemsFilteredTotal Int @default(0)
  lastFetchStats String? // JSON: { fetched, queued, filtered }

  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  items     Item[]
}

model UserStats {
  id             String   @id @default("singleton")

  // Streak
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastVerdictDate DateTime?

  // Counts
  totalKept      Int      @default(0)
  totalDiscarded Int      @default(0)
  totalRevisited Int      @default(0)

  // Weekly stats (reset weekly)
  weekStartDate  DateTime?
  weeklyKept     Int      @default(0)
  weeklyDiscarded Int     @default(0)

  updatedAt      DateTime @updatedAt
}

model AIFollowUp {
  id        String   @id @default(cuid())
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  question  String
  answer    String?
  askedAt   DateTime?
  createdAt DateTime @default(now())
}
